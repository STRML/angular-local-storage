/**
 * An Angular module that gives you access to the browsers local storage
 * @version v0.2.2 - 2015-07-19
 * @link https://github.com/grevory/angular-local-storage
 * @author grevory <greg@gregpike.ca>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */!function(a,b,c){"use strict";var d=b.isDefined,e=b.isUndefined,f=b.isNumber,g=b.isObject,h=b.isArray,i=b.extend,j=b.toJson,k=b.fromJson,l=b.module("LocalStorageModule",[]);l.provider("localStorageService",function(){this.prefix="ls",this.storageType="localStorage",this.cookie={expiry:30,path:"/"},this.notify={setItem:!0,removeItem:!1},this.setPrefix=function(a){return this.prefix=a,this},this.setStorageType=function(a){return this.storageType=a,this},this.setStorageCookie=function(a,b){return this.cookie.expiry=a,this.cookie.path=b,this},this.setStorageCookieDomain=function(a){return this.cookie.domain=a,this},this.setNotify=function(a,b){return this.notify={setItem:a,removeItem:b},this},this.$get=["$rootScope","$window","$document","$parse",function(a,b,c,l){var m,n=this,o=n.prefix,p=n.cookie,q=n.notify,r=n.storageType;c?c[0]&&(c=c[0]):c=document,"."!==o.substr(-1)&&(o=o?o+".":"");var s=function(a){return o+a},t=function(){try{var c=r in b&&null!==b[r],d=s("__"+Math.round(1e7*Math.random()));return c&&(m=b[r],m.setItem(d,""),m.removeItem(d)),c}catch(e){return r="cookie",a.$broadcast("LocalStorageModule.notification.error",e.message),!1}}(),u=function(b,c){if(c=e(c)?null:j(c),!t||"cookie"===n.storageType)return t||a.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),q.setItem&&a.$broadcast("LocalStorageModule.notification.setitem",{key:b,newvalue:c,storageType:"cookie"}),A(b,c);try{m&&m.setItem(s(b),c),q.setItem&&a.$broadcast("LocalStorageModule.notification.setitem",{key:b,newvalue:c,storageType:n.storageType})}catch(d){return a.$broadcast("LocalStorageModule.notification.error",d.message),A(b,c)}return!0},v=function(b){if(!t||"cookie"===n.storageType)return t||a.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),B(b);var c=m?m.getItem(s(b)):null;if(!c||"null"===c)return null;try{return JSON.parse(c)}catch(d){return c}},w=function(){var b,c;for(b=0;b<arguments.length;b++)if(c=arguments[b],t&&"cookie"!==n.storageType)try{m.removeItem(s(c)),q.removeItem&&a.$broadcast("LocalStorageModule.notification.removeitem",{key:c,storageType:n.storageType})}catch(d){a.$broadcast("LocalStorageModule.notification.error",d.message),C(c)}else t||a.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),q.removeItem&&a.$broadcast("LocalStorageModule.notification.removeitem",{key:c,storageType:"cookie"}),C(c)},x=function(){if(!t)return a.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),!1;var b=o.length,c=[];for(var d in m)if(d.substr(0,b)===o)try{c.push(d.substr(b))}catch(e){return a.$broadcast("LocalStorageModule.notification.error",e.Description),[]}return c},y=function(b){var c=o?new RegExp("^"+o):new RegExp,d=b?new RegExp(b):new RegExp;if(!t||"cookie"===n.storageType)return t||a.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),D();var e=o.length;for(var f in m)if(c.test(f)&&d.test(f.substr(e)))try{w(f.substr(e))}catch(g){return a.$broadcast("LocalStorageModule.notification.error",g.message),D()}return!0},z=function(){try{return b.navigator.cookieEnabled||"cookie"in c&&(c.cookie.length>0||(c.cookie="test").indexOf.call(c.cookie,"test")>-1)}catch(d){return a.$broadcast("LocalStorageModule.notification.error",d.message),!1}}(),A=function(b,d,i){if(e(d))return!1;if((h(d)||g(d))&&(d=j(d)),!z)return a.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;try{var k="",l=new Date,m="";if(null===d?(l.setTime(l.getTime()+-864e5),k="; expires="+l.toGMTString(),d=""):f(i)&&0!==i?(l.setTime(l.getTime()+24*i*60*60*1e3),k="; expires="+l.toGMTString()):0!==p.expiry&&(l.setTime(l.getTime()+24*p.expiry*60*60*1e3),k="; expires="+l.toGMTString()),b){var n="; path="+p.path;p.domain&&(m="; domain="+p.domain),c.cookie=s(b)+"="+encodeURIComponent(d)+k+n+m}}catch(o){return a.$broadcast("LocalStorageModule.notification.error",o.message),!1}return!0},B=function(b){if(!z)return a.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;for(var d=c.cookie&&c.cookie.split(";")||[],e=0;e<d.length;e++){for(var f=d[e];" "===f.charAt(0);)f=f.substring(1,f.length);if(0===f.indexOf(s(b)+"=")){var g=decodeURIComponent(f.substring(o.length+b.length+1,f.length));try{return JSON.parse(g)}catch(h){return g}}}return null},C=function(a){A(a,null)},D=function(){for(var a=null,b=o.length,d=c.cookie.split(";"),e=0;e<d.length;e++){for(a=d[e];" "===a.charAt(0);)a=a.substring(1,a.length);var f=a.substring(b,a.indexOf("="));C(f)}},E=function(){return r},F=function(b,c,e,f){f=f||c;var h=v(f);null===h&&d(e)?h=e:g(h)&&g(e)&&(h=i(e,h)),l(c).assign(b,h);var j=function(a,d){d.key===c&&(b[c]=k(d.newvalue),b.$$phase||b.$apply())};a.$on("LocalStorageModule.notification.setitem",j),a.$on("LocalStorageModule.notification.removeitem",j);var m=b.$watch(c,function(a){u(f,a)},g(b[c]));return function(){m(),a.$off("LocalStorageModule.notification.setitem",j),a.$off("LocalStorageModule.notification.removeitem",j)}},G=function(){for(var a=0,c=b[r],d=0;d<c.length;d++)0===c.key(d).indexOf(o)&&a++;return a};return{isSupported:t,getStorageType:E,set:u,add:u,get:v,keys:x,remove:w,clearAll:y,bind:F,deriveKey:s,length:G,cookie:{isSupported:z,set:A,add:A,get:B,remove:C,clearAll:D}}}]})}(window,window.angular);