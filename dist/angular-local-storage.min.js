/**
 * An Angular module that gives you access to the browsers local storage
 * @version v0.2.2 - 2015-07-15
 * @link https://github.com/grevory/angular-local-storage
 * @author grevory <greg@gregpike.ca>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */!function(a,b,c){"use strict";var d=b.isDefined,e=b.isUndefined,f=b.isNumber,g=b.isObject,h=b.isArray,i=b.extend,j=b.toJson,k=b.module("LocalStorageModule",[]);k.provider("localStorageService",function(){this.prefix="ls",this.storageType="localStorage",this.cookie={expiry:30,path:"/"},this.notify={setItem:!0,removeItem:!1},this.setPrefix=function(a){return this.prefix=a,this},this.setStorageType=function(a){return this.storageType=a,this},this.setStorageCookie=function(a,b){return this.cookie.expiry=a,this.cookie.path=b,this},this.setStorageCookieDomain=function(a){return this.cookie.domain=a,this},this.setNotify=function(a,b){return this.notify={setItem:a,removeItem:b},this},this.$get=["$rootScope","$window","$document","$parse",function(a,c,k,l){var m,n=this,o=n.prefix,p=n.cookie,q=n.notify,r=n.storageType;k?k[0]&&(k=k[0]):k=document,"."!==o.substr(-1)&&(o=o?o+".":"");var s=function(a){return o+a},t=function(){try{var b=r in c&&null!==c[r],d=s("__"+Math.round(1e7*Math.random()));return b&&(m=c[r],m.setItem(d,""),m.removeItem(d)),b}catch(e){return r="cookie",a.$broadcast("LocalStorageModule.notification.error",e.message),!1}}(),u=function(b,c){if(c=e(c)?null:j(c),!t||"cookie"===n.storageType)return t||a.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),q.setItem&&a.$broadcast("LocalStorageModule.notification.setitem",{key:b,newvalue:c,storageType:"cookie"}),A(b,c);try{m&&m.setItem(s(b),c),q.setItem&&a.$broadcast("LocalStorageModule.notification.setitem",{key:b,newvalue:c,storageType:n.storageType})}catch(d){return a.$broadcast("LocalStorageModule.notification.error",d.message),A(b,c)}return!0},v=function(b){if(!t||"cookie"===n.storageType)return t||a.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),B(b);var c=m?m.getItem(s(b)):null;if(!c||"null"===c)return null;try{return JSON.parse(c)}catch(d){return c}},w=function(){var b,c;for(b=0;b<arguments.length;b++)if(c=arguments[b],t&&"cookie"!==n.storageType)try{m.removeItem(s(c)),q.removeItem&&a.$broadcast("LocalStorageModule.notification.removeitem",{key:c,storageType:n.storageType})}catch(d){a.$broadcast("LocalStorageModule.notification.error",d.message),C(c)}else t||a.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),q.removeItem&&a.$broadcast("LocalStorageModule.notification.removeitem",{key:c,storageType:"cookie"}),C(c)},x=function(){if(!t)return a.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),!1;var b=o.length,c=[];for(var d in m)if(d.substr(0,b)===o)try{c.push(d.substr(b))}catch(e){return a.$broadcast("LocalStorageModule.notification.error",e.Description),[]}return c},y=function(b){var c=o?new RegExp("^"+o):new RegExp,d=b?new RegExp(b):new RegExp;if(!t||"cookie"===n.storageType)return t||a.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),D();var e=o.length;for(var f in m)if(c.test(f)&&d.test(f.substr(e)))try{w(f.substr(e))}catch(g){return a.$broadcast("LocalStorageModule.notification.error",g.message),D()}return!0},z=function(){try{return c.navigator.cookieEnabled||"cookie"in k&&(k.cookie.length>0||(k.cookie="test").indexOf.call(k.cookie,"test")>-1)}catch(b){return a.$broadcast("LocalStorageModule.notification.error",b.message),!1}}(),A=function(b,c,d){if(e(c))return!1;if((h(c)||g(c))&&(c=j(c)),!z)return a.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;try{var i="",l=new Date,m="";if(null===c?(l.setTime(l.getTime()+-864e5),i="; expires="+l.toGMTString(),c=""):f(d)&&0!==d?(l.setTime(l.getTime()+24*d*60*60*1e3),i="; expires="+l.toGMTString()):0!==p.expiry&&(l.setTime(l.getTime()+24*p.expiry*60*60*1e3),i="; expires="+l.toGMTString()),b){var n="; path="+p.path;p.domain&&(m="; domain="+p.domain),k.cookie=s(b)+"="+encodeURIComponent(c)+i+n+m}}catch(o){return a.$broadcast("LocalStorageModule.notification.error",o.message),!1}return!0},B=function(b){if(!z)return a.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;for(var c=k.cookie&&k.cookie.split(";")||[],d=0;d<c.length;d++){for(var e=c[d];" "===e.charAt(0);)e=e.substring(1,e.length);if(0===e.indexOf(s(b)+"=")){var f=decodeURIComponent(e.substring(o.length+b.length+1,e.length));try{return JSON.parse(f)}catch(g){return f}}}return null},C=function(a){A(a,null)},D=function(){for(var a=null,b=o.length,c=k.cookie.split(";"),d=0;d<c.length;d++){for(a=c[d];" "===a.charAt(0);)a=a.substring(1,a.length);var e=a.substring(b,a.indexOf("="));C(e)}},E=function(){return r},F=function(a,e,f,h){h=h||e;var j=v(h);null===j&&d(f)?j=f:g(j)&&g(f)&&(j=i(f,j)),l(e).assign(a,j);var k=function(c){if(c.key==s(e)){var d=v(e);a[e]&&"object"==typeof a[e]?b.extend(a[e],d):a[e]=d,a.$apply()}};c.addEventListener("storage",k,!1);var m=a.$watch(e,function(a){u(h,a)},g(a[e]));return function(){m(),c.removeEventListener("storage",k)}},G=function(){for(var a=0,b=c[r],d=0;d<b.length;d++)0===b.key(d).indexOf(o)&&a++;return a};return{isSupported:t,getStorageType:E,set:u,add:u,get:v,keys:x,remove:w,clearAll:y,bind:F,deriveKey:s,length:G,cookie:{isSupported:z,set:A,add:A,get:B,remove:C,clearAll:D}}}]})}(window,window.angular);